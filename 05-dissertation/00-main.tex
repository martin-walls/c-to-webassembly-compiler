\documentclass[12pt, a4paper, oneside, openany]{book}

\usepackage[nogeometry, MintedNumberingByChapter]{mrw}

% Flag to exclude environments for word count pdf
\newif\ifCompileForWordCount
\CompileForWordCountfalse
% Flag to hide comments
\newif\ifHideComments
\HideCommentsfalse

\input{03-metadata.tex}
\input{02-styling/00-title-styling.tex}
\input{02-styling/01-colours.tex}
\input{02-styling/02-minted.tex}

\graphicspath{{70-figures/}{71-plots/}}

\input{92.tikzdefs}
\input{92.tikzstyles}

\usepackage[margin=2cm]{geometry}

% For the bibliography
\usepackage[sorting=none]{biblatex}
\addbibresource{90-references.bib}
\NewDocumentCommand{\ccite}{O{}m}{\textcolor{citecolor}{\cite[#1]{#2}}}

% To generate the index
\usepackage{imakeidx}
\makeindex[intoc]

% For including the original project proposal
\usepackage{pdfpages}

\pagestyle{fancy}
\fancyhead[L]{\nouppercase\leftmark}
\fancyhead[R]{\nouppercase\rightmark}
\setlength{\headheight}{14.49998pt}
\addtolength{\topmargin}{-2.49998pt}
\renewcommand{\headrulewidth}{0.3pt}

\setlength{\parindent}{0pt}
\addtolength{\parskip}{1ex}
% slightly increase line spacing to be more readable
\renewcommand{\baselinestretch}{1.1}

% Caption style
\usepackage[font=small,
            labelfont=bf,
            format=hang]{caption}
\usepackage{subcaption}
% Allow listings in subfigure
\DeclareCaptionSubType{listing}

% Figure references
\NewDocumentCommand{\figref}{m}{\textbf{\figurename~\ref{#1}}}
\NewDocumentCommand{\figrefrange}{mm}{\textbf{\figurename s~\ref{#1}--\ref{#2}}}
% Code references
\NewDocumentCommand{\lstref}{m}{\textbf{\listingscaption~\ref{#1}}}
% Section references
\NewDocumentCommand{\secref}{m}{\textbf{Section~\ref{#1}}}

% For showing a directory tree in the repository overview
\usepackage{dirtree}

% Comment box for working on the dissertation
\usepackage{tcolorbox}
\NewDocumentEnvironment{Comment}{}{%
  \begin{tcolorbox}[colback=blue!5!white, colframe=blue!75!black]%
}{%
  \end{tcolorbox}%
}

% try to avoid widows and orphans
\clubpenalty = 1000
\widowpenalty = 1000
\displaywidowpenalty = 1000

% \DeclareSIUnit[quantity-product = {}]{\percent}{\char`\%

% Cross-referencing
% cleveref should be loaded basically last in the preamble (according to the docs)
\usepackage[capitalise, noabbrev, nameinlink]{cleveref}
\newcommand{\crefrangeconjunction}{--}
% Make cross-references coloured
\NewDocumentCommand{\ccref}{m}{\textcolor{refcolor}{\cref{#1}}}
\NewDocumentCommand{\Ccref}{m}{\textcolor{refcolor}{\Cref{#1}}}

\usepackage{comment}
\ifCompileForWordCount
  % exclude figures
  \excludecomment{figure}
  \let\endfigure\relax
  % exclude listings
  \excludecomment{listing}
  \let\endlisting\relax
  % exclude comments
  \excludecomment{Comment}
  % remove headers and footers
  \pagestyle{empty}
  % make 1st page of chapter also be `empty' pagestyle instead of `plain'
  \makeatletter
  \renewcommand\chapter{\if@openright\cleardoublepage\else\clearpage\fi
                      \thispagestyle{empty}% original style: plain
                      \global\@topnum\z@
                      \@afterindentfalse
                      \secdef\@chapter\@schapter}
  \makeatother
  % disable chapter and section numbering
  \setcounter{secnumdepth}{-1}
\fi

\ifHideComments
  \excludecomment{Comment}
\fi

% best loaded last in the preamble (according to https://www.overleaf.com/learn/latex/Multi-file_LaTeX_projects)
\usepackage{subfiles}

\begin{document}

\unless\ifCompileForWordCount
\frontmatter

\subfile{01-frontmatter/00-titlepage.tex}

\pagestyle{plain}

\subfile{01-frontmatter/10-declaration-of-originality.tex}

\subfile{01-frontmatter/20-proforma.tex}

\pagestyle{fancy}

\tableofcontents

\fi % ifCompileForWordCount

\mainmatter

\subfile{10-introduction}

\subfile{20-preparation}

\subfile{30-implementation}

\subfile{40-evaluation}

\subfile{50-conclusions}

\unless\ifCompileForWordCount

\begin{Comment}
References:

\begin{itemize}
\item Relooper algorithm: \cite{emscripten}
\item WebAssembly spec: \cite{wasm-spec}
\item C grammar, Microsoft page: \cite{c-language-grammar-microsoft}
\item Avoiding the dangling else ambiguity in LR parsers (Wiki): \cite{wiki:avoiding-dangling-else-ambiguity}. Wiki page references \cite{final-solution-to-dangling-else} (``A Final Solution to the Dangling Else of ALGOL 60 and Related Languages'')
\item C reference manual book: \cite{c-reference-manual}
\item CLRS algorithms textbook, for interval trees: \cite{clrs-algorithms}
\item LALRPOP tutorial/docs: \cite{lalrpop-docs}
\item WebAssembly memory guide: \cite{wasm-definitive-guide-memory}
\item Addressing Wasm memory: \cite{wasm-addressing-memory}
\end{itemize}
\end{Comment}

\printbibliography[heading=bibintoc]

\printindex

% Start appendices
\appendix
% Show "Appendix X" instead of just "X"
\renewcommand{\ChapterNumber}{\colorbox{white}{\hspace{\ChapterNumberPadding}Appendix \thechapter\hspace{\ChapterNumberPadding}}}

\subfile{60-appendices/10-lexer-fsm.tex}

\subfile{60-appendices/00-original-proposal.tex}

\fi % ifCompileForWordCount

\end{document}

