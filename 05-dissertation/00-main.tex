\documentclass[12pt, a4paper, oneside, openany]{book}

\usepackage[nogeometry, MintedNumberingByChapter, NoSpaceAroundMinted]{mrw}
\usepackage{mrwchapters}

\setmathfont{Libertinus Math}
% Use default Latin Modern math font for symbols.
% See https://en.wikipedia.org/wiki/Mathematical_operators_and_symbols_in_Unicode for symbol ranges.
\setmathfont{latinmodern-math.otf}[range={"2200-"22FF,"2A00-"2AFF}] % chktex 18

% Flag to exclude environments for word count pdf
\newif\ifCompileForWordCount % chktex 1
\CompileForWordCountfalse % chktex 1
% Flag to hide comments
\newif\ifHideComments % chktex 1
\HideCommentsfalse % chktex 1

\input{03-metadata.tex}
\input{02-preamble/01-colours.tex}
\input{02-preamble/02-minted.tex}
\input{02-preamble/03-math-cmds.tex}

\graphicspath{{70-figures/}{71-plots/}}

\input{92.tikzdefs}
\input{92.tikzstyles}

% Number subsubsections
\setcounter{secnumdepth}{4}

\usepackage[margin=2cm]{geometry}

% Provides adjustwidth environment, used for pseudocode listings
\usepackage{changepage}

% For the bibliography
\usepackage[sorting=none,sortcites=true,language=UKenglish]{biblatex}
\addbibresource{90-references.bib}
% Use \mbox so a multiple citation doesn't break over two lines
\NewDocumentCommand{\ccite}{O{}m}{\mbox{\textcolor{citecolor}{\cite[#1]{#2}}}}

% To generate the index
\usepackage{imakeidx}
\makeindex[intoc]

\input{91-glossary.tex}

% For including the original project proposal
\usepackage{pdfpages}

\pagestyle{fancy}
\fancyhead[L]{\nouppercase\leftmark}
\fancyhead[R]{\nouppercase\rightmark}
\setlength{\headheight}{14.49998pt}
\addtolength{\topmargin}{-2.49998pt}
\renewcommand{\headrulewidth}{0.3pt}

\setlength{\parindent}{0pt}
\addtolength{\parskip}{1ex}
% slightly increase line spacing to be more readable
\renewcommand{\baselinestretch}{1.1}

\usepackage{pbox}

% Caption style
\usepackage[font=small,
            labelfont=bf,
            format=hang]{caption}
\usepackage[labelformat=simple, subrefformat=simple]{subcaption}
% Allow listings in subfigure
\DeclareCaptionSubType{listing}
% Use brackets around subfigure/sublisting reference
\renewcommand\thesubfigure{(\alph{subfigure})}
\renewcommand\thesublisting{(\alph{sublisting})}

% Number algorithms by chapter
\renewcommand\thealgorithm{\thechapter.\arabic{algorithm}}
\makeatletter
\@addtoreset{algorithm}{chapter}
\makeatother

% Provides command \FloatBarrier, which prevents floats being moved over it
\usepackage{placeins}

% Redefine `boxed` float style to adjust the spacing.
% - Make the box the same width as \textwidth (by default it's 6.8pt wider)
%   -> the horizontal kerning needs to be 0.4pt smaller than \hsize
% - Increase the vertical padding inside the box
\makeatletter
\renewcommand\fs@boxed{\def\@fs@cfont{\bfseries}\let\@fs@capt\floatc@plain% chktex 1
  \def\@fs@pre{\setbox\@currbox\vbox{\hbadness10000
    \vbox{%
      \hrule\hbox to\hsize{\vrule\kern-0.4pt% chktex 1
        \vbox{\kern9pt\box\@currbox\kern9pt}\kern-0.4pt\vrule}\hrule}}}%
  \def\@fs@mid{\kern2pt}%
  \def\@fs@post{}\let\@fs@iftopcapt\iffalse}
\makeatother

\floatstyle{boxed}
\restylefloat{figure}

% For changing the color of \hline in repository overview table
\usepackage{colortbl}

% For showing a directory tree in the repository overview
\usepackage{dirtree}

% Comment box for working on the dissertation
\usepackage{tcolorbox}
\NewDocumentEnvironment{mrwComment}{}{%
  \begin{tcolorbox}[colback=blue!5!white, colframe=blue!75!black]%
}{%
  \end{tcolorbox}%
}

% try to avoid widows and orphans
\clubpenalty=1000
\widowpenalty=1000
\displaywidowpenalty=1000

% \DeclareSIUnit[quantity-product = {}]{\percent}{\char`\%

% Cross-referencing
% cleveref should be loaded basically last in the preamble (according to the docs)
\usepackage[capitalise, noabbrev, nameinlink]{cleveref}
% \newcommand{\crefrangeconjunction}{--}
% Make cross-references coloured
\NewDocumentCommand{\ccref}{m}{\textcolor{refcolor}{\cref{#1}}}
\NewDocumentCommand{\Ccref}{m}{\textcolor{refcolor}{\Cref{#1}}}
\NewDocumentCommand{\ccrefrange}{mm}{\textcolor{refcolor}{\crefrange{#1}{#2}}}
\NewDocumentCommand{\Ccrefrange}{mm}{\textcolor{refcolor}{\Crefrange{#1}{#2}}}
\NewDocumentCommand{\ccrefeq}{m}{\textcolor{refcolor}{\ref{#1}}}
\NewDocumentCommand{\Ccrefeq}{m}{\ccrefeq{#1}}
\crefname{algstep}{Step}{Steps}

\newlist{EnumerateAlgorithm}{enumerate}{1}
\setlist[EnumerateAlgorithm]{label=\boxed{\arabic*}}

% Environment to wrap EnumerateAlgorithm with lines and a caption
\NewDocumentEnvironment{Algorithm}{mm}
  {%
    \rule{\textwidth}{0.5pt}%
    \vspace{-14pt}%
  }
  {%
    \vspace{-20pt}%
    \rule{\textwidth}{0.5pt}%
    \captionof{algorithm}{#1\label{#2}}
    \medskip
  }

\usepackage{comment}
\ifCompileForWordCount % chktex 1
  % exclude figures
  \excludecomment{figure}
  \let\endfigure\relax
  % exclude listings
  \excludecomment{listing}
  \let\endlisting\relax
  % exclude comments
  \excludecomment{mrwComment}
  % remove headers and footers
  \pagestyle{empty}
  % make 1st page of chapter also be `empty' pagestyle instead of `plain'
  \makeatletter
  \renewcommand\chapter{\if@openright\cleardoublepage\else\clearpage\fi
                      \thispagestyle{empty}% original style: plain
                      \global\@topnum\z@
                      \@afterindentfalse % chktex 1
                      \secdef\@chapter\@schapter}
  \makeatother
  % disable chapter and section numbering
  \setcounter{secnumdepth}{-1}
  % Don't try to calculate references, it seems to break when we disable section numbering
  \RenewDocumentCommand{\ccref}{m}{\textcolor{refcolor}{ref}}
  \RenewDocumentCommand{\Ccref}{m}{\textcolor{refcolor}{ref}}
  \RenewDocumentCommand{\ccrefrange}{mm}{\textcolor{refcolor}{refrange}}
  \RenewDocumentCommand{\Ccrefrange}{mm}{\textcolor{refcolor}{refrange}}
\fi

\ifHideComments % chktex 1
  \excludecomment{mrwComment}
\fi

% best loaded last in the preamble (according to https://www.overleaf.com/learn/latex/Multi-file_LaTeX_projects)
\usepackage{subfiles}

\begin{document}

\unless\ifCompileForWordCount % chktex 1
\frontmatter

\subfile{01-frontmatter/00-titlepage.tex}

\pagestyle{plain}

\subfile{01-frontmatter/10-declaration-of-originality.tex}

\subfile{01-frontmatter/20-proforma.tex}

\pagestyle{fancy}

\tableofcontents

\fi % ifCompileForWordCount

\mainmatter % chktex 1

\subfile{10-introduction}

\subfile{20-preparation}

\subfile{30-implementation}

\subfile{40-evaluation}

\subfile{50-conclusions}

\unless\ifCompileForWordCount % chktex 1

\printbibliography[heading=bibintoc]

% \printindex

% Start appendices
\appendix
% Show "Appendix X" instead of just "X"
\renewcommand{\ChapterNumber}{\colorbox{white}{\hspace{\ChapterNumberPadding}Appendix \thechapter\hspace{\ChapterNumberPadding}}}

\subfile{60-appendices/40-supplementary-implementation.tex}

\subfile{60-appendices/10-lexer-fsm.tex}

% Probably not really worth including the whole grammar?
% \subfile{60-appendices/20-parser-grammar.tex}

\subfile{60-appendices/30-intermediate-code.tex}

\subfile{60-appendices/00-original-proposal.tex}

\fi % ifCompileForWordCount

\end{document}

