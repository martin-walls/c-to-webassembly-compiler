\documentclass[00-main.tex]{subfiles}

\begin{document}

\chapter{Implementation}

\begin{Comment}
Word budget: \textasciitilde 4500--5400 words
\end{Comment}

\section{Repository Overview}

% formatting commands for files/directories in tree
\newcommand{\DTfile}[1]{#1}
\newcommand{\DTdir}[1]{\textbf{#1}/}

I developed my project in a GitHub repository\footnote{\url{https://github.com/martin-walls/cam-part-ii-c-webassembly-compiler}}, ensuring to regularly push to the cloud for backup purposes.
This repository is a monorepo containing both my research and documentation along with my source code.

% - horizontal offset of vertical lines to the right
% - width of horizontal lines sticking out
% - separation between horizontal lines and start of text
% - length of horizontal lines
% - size of connecting dots
\DTsetlength{0.2em}{1em}{0.2em}{0.4pt}{2pt}

\makeatletter
\newcommand \Dotfill {\leavevmode \cleaders \hb@xt@ .7em{\hss .\hss }\hfill \kern \z@}
\makeatother
\renewcommand{\DTcomment}[1]{%
\Dotfill
\rmfamily
\begin{minipage}[t]{8cm}
#1
\end{minipage}
}

\dirtree{%
.1 .
.2 \DTdir{headers} \DTcomment{Header files for the standard library functions I implemented}.
.3 \DTfile{stdio.h}.
.3 {...}.
.2 \DTdir{runtime} \DTcomment{NodeJS runtime environment}.
.3 \DTdir{stdlib} \DTcomment{Implementations of standard library functions in JS}.
.3 \DTfile{run.mjs}.
.3 {...}.
.2 \DTdir{src} \DTcomment{The source code for the compiler, explained below}.
.3 {...}.
.2 \DTdir{tests} \DTcomment{Test specification files}.
.3 {...}.
.2 \DTdir{tools}.
.3 \DTfile{profiler.py} \DTcomment{Code to plot stack usage profiles}.
.3 \DTfile{testsuite.py} \DTcomment{Test runner}.
}

\dirtree{%
.1 \DTdir{src}.
.2 \DTdir{back\_end}.
.2 \DTdir{data\_structures}.
.2 \DTdir{front\_end}.
.2 \DTdir{middle\_end}.
.2 \DTdir{program\_config}.
.2 \DTdir{relooper}.
.2 \DTfile{fmt\_indented.rs}.
.2 \DTfile{id.rs}.
.2 \DTfile{lib.rs}.
.2 \DTfile{main.rs}.
.2 \DTfile{preprocessor.rs}.
}

\begin{Comment}
Finish this. Will have to see if it'll be better to have comments on the right of dirs, or to highlight the main structure below
\end{Comment}

\section{System Architecture}

\begin{Comment}
Compiler Pipeline overview -- include the diagram here
\end{Comment}

\section{Front End: Lexer and Parser}

\begin{Comment}
Describe what was actually produced.

Describe any design strategies that looked ahead to the testing phase, to demonstrate professional approach

\end{Comment}

\begin{Comment}
- wrote parser grammar

Talk about avoiding ambiguities - eg. dangling else - by using Open/Closed statement in grammar

Talk about my \texttt{interpret\_string} implementation, to handle string escaping. Implemented using an iterator.

- wrote custom lexer - cos typedefs make C context-sensitive, so handle them as we see them so they don't get mixed with identifiers

- created AST representation

Talk about structure of my AST

Talk about how I parsed type specifiers into a standard type representation. Used a bitfield to parse arithmetic types, cos they can be declared in any order.
\end{Comment}

\begin{Comment}
Describe high-level structure of codebase.

Say that I wrote it from scratch.

-> mention LALRPOP parser generator used for .lalrpop files
\end{Comment}

\section{Middle End: Intermediate Representation}

\begin{Comment}
- Defined my own three-address code representation

- for every ast node, defined transformation to 3AC instructions

- created IR data structure to hold instructions + all necessary metadata

- Talk about auto-incrementing IDs - abstraction of the Id trait and generic IdGenerator struct

- handled type information - created data structure to represent possible types

- making sure instructions are type-safe, type converting where necessary - talk about unary/binary conversions, cite the C reference book

- Compile-time evaluation of expressions, eg. for array sizes

- Talk about the Context design pattern I used throughout -- maybe research this and see if it's been done before?
\end{Comment}

\section{The Relooper Algorithm}

\begin{Comment}
cite Emscripten \cite{emscripten}
\end{Comment}

\section{Back End: Target Code Generation}


\section{Optimisations}

\subsection{Unreachable Procedure Elimination}

\subsection{Tail-Call Optimisation}

\begin{Comment}
Defn of tail-call optimisation

Why do the optimisation
\end{Comment}

\section{Summary}

\end{document}
